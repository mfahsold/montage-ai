name: CI — quota‑constrained smoke
on:
  workflow_dispatch: {}
  schedule:
    - cron: '0 4 * * *' # nightly
jobs:
  smoke-quota:
    name: Smoke (quota‑constrained overlay)
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      - name: Run quota‑constrained kustomize build
        run: |
          kubectl kustomize deploy/k3s/overlays/distributed-quota-constrained > /tmp/manifest.yaml
          kubectl apply -n montage-ai -f /tmp/manifest.yaml --dry-run=client
      - name: Run preview smoke (uses existing RWX PVCs)
        run: |
          export TEST_BASE_URL=${{ secrets.DEV_BASE_URL }}
          ./scripts/ci/preview-benchmark.sh BASE=${TEST_BASE_URL} RUNS=5
