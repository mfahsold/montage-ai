name: Dev â€” autoscale smoke (manual)

on:
  workflow_dispatch:
    inputs:
      overlay:
        description: 'Kustomize overlay to apply (defaults to canonical production overlay)'
        required: false
        default: 'deploy/k3s/overlays/production'
      run_preview_slo:
        description: 'Run the optional on-cluster preview SLO benchmark (self-hosted runner required)'
        required: false
        default: 'false'

jobs:
  dev-autoscale-smoke:
    name: Dev autoscale smoke (requires dev runner with cluster access)
    runs-on: [self-hosted, linux, dev]
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set image tag
        run: |
          echo "IMAGE_TAG=dev-$(git rev-parse --short HEAD)" >> $GITHUB_ENV

      - name: Build and push image (runner must be able to reach cluster registry)
        run: |
          docker build -t 127.0.0.1:30500/montage-ai:${IMAGE_TAG} .
          docker push 127.0.0.1:30500/montage-ai:${IMAGE_TAG}

      - name: Deploy (kustomize)
        env:
          OVERLAY: "${{ inputs.overlay || 'deploy/k3s/overlays/production' }}"
        run: |
          echo "Using overlay: $OVERLAY"
          kubectl -n montage-ai set image deploy/montage-ai-web montage-ai=127.0.0.1:30500/montage-ai:${IMAGE_TAG} || true
          kubectl -n montage-ai set image deploy/montage-ai-worker montage-ai=127.0.0.1:30500/montage-ai:${IMAGE_TAG} || true
          kubectl -n montage-ai apply -k "$OVERLAY"
          kubectl -n montage-ai rollout status deploy/montage-ai-web --timeout=3m
          kubectl -n montage-ai rollout status deploy/montage-ai-worker --timeout=3m

      - name: Run infra & smoke tests
        env:
          TEST_BASE_URL: http://127.0.0.1:8080
        run: |
          ./scripts/ci/run-dev-smoke.sh ${IMAGE_TAG}

      - name: Run on-cluster preview SLO benchmark (self-hosted only)
        if: github.event.inputs.run_preview_slo == 'true'
        env:
          TEST_BASE_URL: http://127.0.0.1:8080
          SLO_P50: 8
          SLO_P95: 30
        run: |
          ./scripts/ci/preview-benchmark.sh ${TEST_BASE_URL}

      - name: Collect logs (on failure)
        if: failure()
        run: |
          kubectl -n montage-ai get pods -o wide
          kubectl -n montage-ai logs -l app=montage-ai --tail=200
