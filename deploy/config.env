# =============================================================================
# Deployment Configuration - Centralized for all environments
# =============================================================================
# This file is sourced by deployment scripts and Kubernetes manifests.
# Copy and customize for your environment.
# =============================================================================

# Registry Configuration
# For ghcr.io: REGISTRY_HOST=ghcr.io/<org> REGISTRY_PORT=""
# For local registry: REGISTRY_HOST=registry.local REGISTRY_PORT=5000
REGISTRY_HOST="${REGISTRY_HOST:-registry.example.com}"
REGISTRY_PORT="${REGISTRY_PORT:-5000}"
REGISTRY_URL="${REGISTRY_HOST}${REGISTRY_PORT:+:${REGISTRY_PORT}}"

# Image Configuration
IMAGE_NAME="${IMAGE_NAME:-montage-ai}"
IMAGE_TAG="${IMAGE_TAG:-latest}"
IMAGE_FULL="${REGISTRY_URL}/${IMAGE_NAME}:${IMAGE_TAG}"

# UV (Astral) Configuration
# Version of uv used for CI and local development. Pin for reproducible builds.
UV_VERSION="${UV_VERSION:-0.9.24}"
# Official uv GHCR image (use in Docker builds if desired)
UV_IMAGE="${UV_IMAGE:-ghcr.io/astral-sh/uv:${UV_VERSION}}"
# UV cache directory (used for CI and local caching)
UV_CACHE_DIR="${UV_CACHE_DIR:-$HOME/.cache/uv}"

# Kubernetes Configuration
CLUSTER_NAMESPACE="${CLUSTER_NAMESPACE:-montage-ai}"
CLUSTER_API_SERVER="${CLUSTER_API_SERVER:-https://kubernetes.default.svc:6443}"

# Shared services (override per environment)
REDIS_HOST="${REDIS_HOST:-redis.${CLUSTER_NAMESPACE}.svc.cluster.local}"
REDIS_PORT="${REDIS_PORT:-6379}"

# Domain Configuration
APP_DOMAIN="${APP_DOMAIN:-montage-ai.example.com}"
TLS_SECRET="${TLS_SECRET:-montage-ai-tls}"

# Application Configuration
APP_NAME="${APP_NAME:-montage-ai}"
APP_LABEL="${APP_LABEL:-app=montage-ai}"

# Staging / Autoscaling defaults (can be overridden per-overlay or env)
# - sensible, conservative defaults to avoid hardcoding values in manifests
WORKER_MIN_REPLICAS="${WORKER_MIN_REPLICAS:-2}"
WORKER_MAX_REPLICAS="${WORKER_MAX_REPLICAS:-12}"
WORKER_QUEUE_SCALE_THRESHOLD="${WORKER_QUEUE_SCALE_THRESHOLD:-10}"
MAX_CONCURRENT_JOBS_DEFAULT="${MAX_CONCURRENT_JOBS_DEFAULT:-2}"
MAX_PARALLEL_JOBS_DEFAULT="${MAX_PARALLEL_JOBS_DEFAULT:-2}"

# Data Paths (Container internal)
DATA_INPUT_DIR="${DATA_INPUT_DIR:-/data/input}"
DATA_OUTPUT_DIR="${DATA_OUTPUT_DIR:-/data/output}"
DATA_MUSIC_DIR="${DATA_MUSIC_DIR:-/data/music}"
DATA_ASSETS_DIR="${DATA_ASSETS_DIR:-/data/assets}"
DATA_LUTS_DIR="${DATA_LUTS_DIR:-/data/luts}"

# Temp directory selection (prefer /dev/shm when sufficiently large)
TEMP_DIR="${TEMP_DIR:-}"
TEMP_DIR_MIN_FREE_MB="${TEMP_DIR_MIN_FREE_MB:-512}"

# Storage Configuration
STORAGE_CLASS="${STORAGE_CLASS:-nfs-client}"
PVC_NAME="${PVC_NAME:-montage-ai-data}"
PVC_SIZE="${PVC_SIZE:-100Gi}"
PVC_INPUT_NAME="${PVC_INPUT_NAME:-}"
PVC_OUTPUT_NAME="${PVC_OUTPUT_NAME:-}"
PVC_MUSIC_NAME="${PVC_MUSIC_NAME:-}"
PVC_ASSETS_NAME="${PVC_ASSETS_NAME:-}"

# Service Configuration
SERVICE_PORT="${SERVICE_PORT:-5000}"
SERVICE_TARGET_PORT="${SERVICE_TARGET_PORT:-5000}"
SERVICE_NAME="${SERVICE_NAME:-montage-ai-web}"

# Ingress Configuration
INGRESS_NAME="${INGRESS_NAME:-montage-ai-web}"
INGRESS_MAX_REQUEST_BODY="${INGRESS_MAX_REQUEST_BODY:-5000000000}"

# Backend API Configuration
BACKEND_API_URL="${BACKEND_API_URL:-http://localhost:${SERVICE_PORT}}"

# Testing Configuration
TEST_BASE_URL="${TEST_BASE_URL:-http://localhost:${SERVICE_PORT}}"
TEST_UPLOAD_URL="${TEST_UPLOAD_URL:-http://localhost:5001/api/upload}"

# LLM / OpenAI-Compatible API Configuration (Together, LiteLLM, vLLM, LocalAI)
# Example Together base: https://api.together.xyz/v1
OPENAI_API_BASE="${OPENAI_API_BASE:-}"
OPENAI_API_KEY="${OPENAI_API_KEY:-}"
OPENAI_MODEL="${OPENAI_MODEL:-auto}"
OPENAI_VISION_MODEL="${OPENAI_VISION_MODEL:-}"

# cgpu (cloud LLM + GPU offload)
CGPU_ENABLED="${CGPU_ENABLED:-false}"
CGPU_GPU_ENABLED="${CGPU_GPU_ENABLED:-false}"
CGPU_HOST="${CGPU_HOST:-}"
CGPU_PORT="${CGPU_PORT:-8080}"
CGPU_MODEL="${CGPU_MODEL:-gemini-2.0-flash}"
CGPU_TIMEOUT="${CGPU_TIMEOUT:-1200}"
CGPU_MAX_CONCURRENCY="${CGPU_MAX_CONCURRENCY:-1}"
CGPU_STATUS_TIMEOUT="${CGPU_STATUS_TIMEOUT:-30}"
CGPU_GPU_CHECK_TIMEOUT="${CGPU_GPU_CHECK_TIMEOUT:-120}"
CGPU_OUTPUT_DIR="${CGPU_OUTPUT_DIR:-}"

# Final encode routing (ffmpeg | router)
FINAL_ENCODE_BACKEND="${FINAL_ENCODE_BACKEND:-ffmpeg}"
FORCE_CGPU_ENCODING="${FORCE_CGPU_ENCODING:-false}"

# Ollama (local or in-cluster)
OLLAMA_HOST="${OLLAMA_HOST:-http://ollama.${CLUSTER_NAMESPACE}.svc.cluster.local:11434}"

# Preview fast-path defaults (tunable)
PREVIEW_MAX_INPUT_SIZE_MB="${PREVIEW_MAX_INPUT_SIZE_MB:-200}"
PREVIEW_MAX_FILES="${PREVIEW_MAX_FILES:-3}"

# FFmpeg hwaccel override (set to 'auto'|'none'|'nvenc'|'vaapi'|'qsv' etc.)
# Use 'none' to force software-only (useful for CI and constrained nodes).
FFMPEG_HWACCEL="${FFMPEG_HWACCEL:-auto}"

# Optional ffmpeg MCP service (cluster or remote)
USE_FFMPEG_MCP="${USE_FFMPEG_MCP:-false}"
FFMPEG_MCP_ENDPOINT="${FFMPEG_MCP_ENDPOINT:-}"
FFMPEG_MCP_HOST="${FFMPEG_MCP_HOST:-}"
FFMPEG_MCP_PORT="${FFMPEG_MCP_PORT:-8080}"

# Proxy cache policy (TTL seconds, max bytes)
PROXY_CACHE_TTL_SECONDS="${PROXY_CACHE_TTL_SECONDS:-86400}"
PROXY_CACHE_MAX_BYTES="${PROXY_CACHE_MAX_BYTES:-1073741824}"
PROXY_CACHE_MIN_AGE_SECONDS="${PROXY_CACHE_MIN_AGE_SECONDS:-60}"

# Proxy cache (shared) and lock timeout
PROXY_CACHE_DIR="${PROXY_CACHE_DIR:-/data/output/proxy-cache}"
PROXY_LOCK_TIMEOUT_SECONDS="${PROXY_LOCK_TIMEOUT_SECONDS:-900}"

# Proxy sizing (adaptive heights based on file size)
ADAPTIVE_PROXY_HEIGHT="${ADAPTIVE_PROXY_HEIGHT:-true}"
PROXY_HEIGHT="${PROXY_HEIGHT:-720}"
PROXY_HEIGHT_SMALL="${PROXY_HEIGHT_SMALL:-360}"
PROXY_HEIGHT_MEDIUM="${PROXY_HEIGHT_MEDIUM:-540}"
PROXY_HEIGHT_LARGE="${PROXY_HEIGHT_LARGE:-720}"
PROXY_HEIGHT_SMALL_MAX_MB="${PROXY_HEIGHT_SMALL_MAX_MB:-512}"
PROXY_HEIGHT_MEDIUM_MAX_MB="${PROXY_HEIGHT_MEDIUM_MAX_MB:-2048}"

# Distributed proxy generation (cluster sharding)
PROXY_DISTRIBUTED_ENABLED="${PROXY_DISTRIBUTED_ENABLED:-false}"
PROXY_DISTRIBUTED_MIN_FILES="${PROXY_DISTRIBUTED_MIN_FILES:-8}"
PROXY_DISTRIBUTED_MIN_TOTAL_MB="${PROXY_DISTRIBUTED_MIN_TOTAL_MB:-2048}"

# Deployment Strategy
DEPLOYMENT_STRATEGY="${DEPLOYMENT_STRATEGY:-RollingUpdate}"
DEPLOYMENT_MIN_READY_SECONDS="${DEPLOYMENT_MIN_READY_SECONDS:-0}"

# Resource Limits
MEMORY_LIMIT="${MEMORY_LIMIT:-4Gi}"
MEMORY_REQUEST="${MEMORY_REQUEST:-2Gi}"
CPU_LIMIT="${CPU_LIMIT:-2000m}"
CPU_REQUEST="${CPU_REQUEST:-500m}"

# Logging Configuration
LOG_LEVEL="${LOG_LEVEL:-INFO}"
