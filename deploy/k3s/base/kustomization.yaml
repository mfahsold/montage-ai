apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: montage-ai

resources:
  - cluster-rbac.yaml
  - deployment.yaml
  - worker.yaml
  - cgpu-server.yaml
  - service-ingress.yaml
  - redis.yaml
  - pvc.yaml
  - namespace.yaml
  - network-policy.yaml
  - pdb.yaml

# =============================================================================
# Image Configuration (config-global.yaml -> cluster-config.env)
# =============================================================================
# Render deploy/k3s/base/cluster-config.env via:
#   make -C deploy/k3s config
# Images are updated via replacements using IMAGE_FULL.

# ConfigMap for deployment settings (overlays can patch)
configMapGenerator:
  - name: cluster-config
    behavior: create
    envs:
      - cluster-config.env

  - name: montage-ai-config
    behavior: create
    literals:
      - CUT_STYLE=dynamic
      - STABILIZE=false
      - UPSCALE=false
      - ENHANCE=false
      - OPENAI_API_BASE=http://litellm.llama-box-system.svc.cluster.local:4000/v1
      - OPENAI_API_KEY=sk-1234
      - OPENAI_MODEL=auto
      - OPENAI_VISION_MODEL=
      - OLLAMA_HOST=http://ollama.montage-ai.svc.cluster.local:11434
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - CLUSTER_MODE=true
      - CLUSTER_PARALLELISM=4
      - CLUSTER_RENDER_TIER=large
      - MONTAGE_CLUSTER_MODE=k8s
      - CLUSTER_USE_JOBSET=true
      - segment_writer.py=patches/segment_writer.py
  - name: montage-ai-patch-clip-processor
    files:
      - clip_processor.py=patches/clip_processor.py
  - name: montage-ai-patch-analysis-engine
    files:
      - analysis_engine.py=patches/analysis_engine.py
  - name: montage-ai-patch-hardware
    files:
      - hardware.py=patches/hardware.py
  - name: montage-ai-patch-creative-director
    files:
      - creative_director.py=patches/creative_director.py
  - name: montage-ai-patch-proxy-generator
    files:
      - proxy_generator.py=patches/proxy_generator.py

replacements:
  - source:
      kind: ConfigMap
      name: cluster-config
      fieldPath: data.IMAGE_FULL
    targets:
      - select:
          kind: Deployment
          name: montage-ai-web
        fieldPaths:
          - spec.template.spec.containers.[name=montage-ai].image
      - select:
          kind: Deployment
          name: cgpu-server
        fieldPaths:
          - spec.template.spec.initContainers.[name=cgpu-credentials-init].image
          - spec.template.spec.containers.[name=cgpu-server].image
      - select:
          kind: Job
          name: montage-ai-render
        fieldPaths:
          - spec.template.spec.initContainers.[name=cgpu-credentials-init].image
          - spec.template.spec.containers.[name=montage-ai].image

  - source:
      kind: ConfigMap
      name: cluster-config
      fieldPath: data.MONTAGE_HOSTNAME
    targets:
      - select:
          kind: Ingress
          name: montage-ai-web
        fieldPaths:
          - spec.rules.0.host
