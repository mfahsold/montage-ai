apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: montage-ai

resources:
  - priority-classes.yaml
  - deployment.yaml
  - cgpu-server.yaml
  - service-ingress.yaml
  - redis.yaml
  - pvc.yaml
  - namespace.yaml
  - network-policy.yaml
  - job.yaml
  - pdb.yaml

# =============================================================================
# Image Configuration (config-global.yaml -> cluster-config.env)
# =============================================================================
# Render deploy/k3s/base/cluster-config.env via:
#   make -C deploy/k3s config
# Images are updated via replacements using IMAGE_FULL.

# ConfigMap for deployment settings (overlays can patch)
configMapGenerator:
  - name: cluster-config
    behavior: create
    envs:
      - cluster-config.env

  - name: montage-ai-config
    behavior: create
    literals:
      - CUT_STYLE=dynamic
      - STABILIZE=false
      - UPSCALE=false
      - ENHANCE=false
      - OPENAI_API_BASE=http://llama-box-api-distributed.llama-box-system.svc.cluster.local:8080/v1
      - OPENAI_MODEL=qwen2.5-32b-instruct-q8_0-00001-of-00009.gguf
      - OPENAI_VISION_MODEL=
      - OLLAMA_HOST=http://llama-box-api.llama-box-system.svc.cluster.local:8080
      - LLM_TIMEOUT=120
      - CGPU_ENABLED=true
      - CGPU_HOST=cgpu-server
      - CGPU_PORT=8080
      - PREVIEW_MAX_INPUT_SIZE_MB=10000
      - PREVIEW_MAX_FILES=50
      - QUEUE_FAST_NAME=default
      - QUEUE_HEAVY_NAME=heavy

  - name: montage-ai-script
    files:
      - montage-ai.sh=../../../montage-ai.sh
  - name: montage-ai-patch-segment-writer
    files:
      - segment_writer.py=../../../src/montage_ai/segment_writer.py
  - name: montage-ai-patch-clip-processor
    files:
      - clip_processor.py=../../../src/montage_ai/core/clip_processor.py
  - name: montage-ai-patch-analysis-engine
    files:
      - analysis_engine.py=../../../src/montage_ai/core/analysis_engine.py
  - name: montage-ai-patch-hardware
    files:
      - hardware.py=../../../src/montage_ai/core/hardware.py
  - name: montage-ai-patch-creative-director
    files:
      - creative_director.py=../../../src/montage_ai/creative_director.py
  - name: montage-ai-patch-proxy-generator
    files:
      - proxy_generator.py=../../../src/montage_ai/proxy_generator.py

replacements:
  - source:
      kind: ConfigMap
      name: cluster-config
      fieldPath: data.IMAGE_FULL
    targets:
      - select:
          kind: Deployment
          name: montage-ai-web
        fieldPaths:
          - spec.template.spec.containers.[name=montage-ai].image
      - select:
          kind: Deployment
          name: cgpu-server
        fieldPaths:
          - spec.template.spec.initContainers.[name=cgpu-credentials-init].image
          - spec.template.spec.containers.[name=cgpu-server].image
      - select:
          kind: Job
          name: montage-ai-render
        fieldPaths:
          - spec.template.spec.initContainers.[name=cgpu-credentials-init].image
          - spec.template.spec.containers.[name=montage-ai].image
  - source:
      kind: ConfigMap
      name: cluster-config
      fieldPath: data.STORAGE_CLASS_DEFAULT
    targets:
      - select:
          kind: PersistentVolumeClaim
          name: montage-input
        fieldPaths:
          - spec.storageClassName
      - select:
          kind: PersistentVolumeClaim
          name: montage-music
        fieldPaths:
          - spec.storageClassName
      - select:
          kind: PersistentVolumeClaim
          name: montage-assets
        fieldPaths:
          - spec.storageClassName
      - select:
          kind: PersistentVolumeClaim
          name: montage-output
        fieldPaths:
          - spec.storageClassName
      - select:
          kind: PersistentVolumeClaim
          name: montage-cache
        fieldPaths:
          - spec.storageClassName
  - source:
      kind: ConfigMap
      name: cluster-config
      fieldPath: data.MONTAGE_HOSTNAME
    targets:
      - select:
          kind: Ingress
          name: montage-ai-web
        fieldPaths:
          - spec.rules.0.host
