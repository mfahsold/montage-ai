apiVersion: batch/v1
kind: Job
metadata:
  name: montage-ai-smoke-runner
  namespace: montage-ai
  labels:
    app.kubernetes.io/name: montage-ai
    app.kubernetes.io/component: smoke-runner
spec:
  backoffLimit: 0
  template:
    spec:
      # Use the same service account as the web app if permissions are needed
      serviceAccountName: montage-ai-cluster
      restartPolicy: Never
      containers:
        - name: smoke-runner
          image: ${IMAGE_FULL}
          imagePullPolicy: IfNotPresent
          command: ["/bin/bash", "-lc"]
          args:
            - |
              set -euo pipefail
              echo "Starting in-cluster smoke runner"
              export PYTHONPATH=/app/src
              # Wait for web service to be Ready
              echo "Waiting for web service to be responsive..."
              for try in $(seq 0 30); do
                if curl -fsS http://montage-ai-web/api/status -m 3 >/dev/null 2>&1; then
                  break
                fi
                sleep 2
              done
              echo "Running smoke tests (in-cluster HTTP smoke)"
              echo 'aW1wb3J0IG9zLCB0aW1lLCByZXF1ZXN0cywgc3lzCkJBU0UgPSBvcy5lbnZpcm9uLmdldCgiVEVTVF9CQVNFX1VSTCIsICJodHRwOi8vbW9udGFnZS1haS13ZWIiKQpqb2JfaWRzID0gW10KZm9yIF8gaW4gcmFuZ2UoMyk6CiAgICByID0gcmVxdWVzdHMucG9zdChmIntCQVNFfS9hcGkvam9icyIsIGpzb249eyJzdHlsZSI6ICJkeW5hbWljIiwgIm9wdGlvbnMiOiB7fSwgInF1YWxpdHlfcHJvZmlsZSI6ICJwcmV2aWV3In0sIHRpbWVvdXQ9MTApCiAgICBpZiByLnN0YXR1c19jb2RlIG5vdCBpbiAoMjAwLCAyMDEpOgogICAgICAgIHByaW50KCJqb2IgY3JlYXRlIGZhaWxlZCIsIHIuc3RhdHVzX2NvZGUsIHIudGV4dCkKICAgICAgICBzeXMuZXhpdCgxKQogICAgZGF0YSA9IHIuanNvbigpCiAgICBqb2JfaWRzLmFwcGVuZChkYXRhLmdldCgiam9iX2lkIikgb3IgZGF0YS5nZXQoImlkIikgb3IgZGF0YS5nZXQoImpvYklkIikpCiAgICB0aW1lLnNsZWVwKDEpCmlmIG5vdCBqb2JfaWRzOgogICAgcHJpbnQoIm5vIGpvYnMgY3JlYXRlZCIpCiAgICBzeXMuZXhpdCgyKQpkZWFkbGluZSA9IHRpbWUudGltZSgpICsgMzAwCmNvbXBsZXRlZCA9IHNldCgpCndoaWxlIHRpbWUudGltZSgpIDwgZGVhZGxpbmUgYW5kIGxlbihjb21wbGV0ZWQpIDwgbGVuKGpvYl9pZHMpOgogICAgZm9yIGppZCBpbiBqb2JfaWRzOgogICAgICAgIGlmIGppZCBpbiBjb21wbGV0ZWQ6CiAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgciA9IHJlcXVlc3RzLmdldChmIntCQVNFfS9hcGkvam9icy97amlkfSIsIHRpbWVvdXQ9NSkKICAgICAgICBpZiByLnN0YXR1c19jb2RlID09IDIwMDoKICAgICAgICAgICAgc3QgPSByLmpzb24oKS5nZXQoInN0YXR1cyIpCiAgICAgICAgICAgIGlmIHN0IGluICgiZmluaXNoZWQiLCAiY29tcGxldGVkIiwgImRvbmUiLCAiZmFpbGVkIik6CiAgICAgICAgICAgICAgICBjb21wbGV0ZWQuYWRkKGppZCkKICAgIHRpbWUuc2xlZXAoMykKaWYgbGVuKGNvbXBsZXRlZCkgIT0gbGVuKGpvYl9pZHMpOgogICAgcHJpbnQoIk5vdCBhbGwgam9icyBmaW5pc2hlZCIsIGxlbihjb21wbGV0ZWQpLCAib2YiLCBsZW4oam9iX2lkcykpCiAgICBzeXMuZXhpdCgzKQpwcmludCgiQWxsIGpvYnMgZmluaXNoZWQiKQo=' | base64 -d > /tmp/smoke.py && python /tmp/smoke.py
      # Optional: set resource requests so job can schedule in small dev clusters
      tolerations:
        - key: "gpu"
          operator: "Equal"
          value: "amd-rocm"
          effect: "NoSchedule"
      nodeSelector: {}
