# Distributed Rendering Overlay
#
# Uses NFS storage for multi-node GPU access.
# Jobs can run on ANY GPU node (AMD, Jetson, or both).
#
# Usage:
#   kubectl apply -k deploy/k3s/overlays/distributed/

apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: montage-ai

# Use internal registry
images:
- name: ghcr.io/mfahsold/montage-ai
  newName: 192.168.1.12:30500/montage-ai
  newTag: latest-amd64

  # NFS PVCs are expected to exist in the cluster already
resources:
- ../../base
- ../../distributed/worker-daemonset.yaml

  # Use JSON 6902 patch to REPLACE volumes (not add)

patches:
- patch: |-
    - op: replace
      path: /spec/template/spec/nodeSelector
      value: null
    - op: replace
      path: /spec/template/spec/affinity
      value:
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              preference:
                matchExpressions:
                  - key: nvidia.com/gpu
                    operator: Exists
            - weight: 90
              preference:
                matchExpressions:
                  - key: amd.com/gpu
                    operator: Exists
    - op: replace
      path: /spec/template/spec/volumes
      value:
        - name: input
          persistentVolumeClaim:
            claimName: montage-ai-input-nfs
        - name: music
          persistentVolumeClaim:
            claimName: montage-ai-music-nfs
        - name: assets
          persistentVolumeClaim:
            claimName: montage-ai-assets-nfs
        - name: output
          persistentVolumeClaim:
            claimName: montage-ai-output-nfs
        - name: cgpu-config
          emptyDir: {}
        - name: cgpu-secrets
          secret:
            secretName: cgpu-credentials
            optional: true
            items:
              - key: config.json
                path: config.json
              - key: session.json
                path: session.json
        - name: dev-dri
          hostPath:
            path: /dev/dri
            type: DirectoryOrCreate
        - name: shm
          emptyDir:
            medium: Memory
            sizeLimit: 1Gi
        - name: script
          configMap:
            name: montage-ai-script
            defaultMode: 0755
        - name: patch-segment-writer
          configMap:
            name: montage-ai-patch-segment-writer
        - name: patch-clip-processor
          configMap:
            name: montage-ai-patch-clip-processor
        - name: patch-analysis-engine
          configMap:
            name: montage-ai-patch-analysis-engine
        - name: patch-hardware
          configMap:
            name: montage-ai-patch-hardware
        - name: patch-creative-director
          configMap:
            name: montage-ai-patch-creative-director
        - name: patch-proxy-generator
          configMap:
            name: montage-ai-patch-proxy-generator
    - op: replace
      path: /spec/template/spec/containers/0/imagePullPolicy
      value: Always
    - op: replace
      path: /spec/template/spec/initContainers/0/imagePullPolicy
      value: Always
  target:
    kind: Job
    name: montage-ai-render
- patch: |-
    - op: replace
      path: /spec/template/spec/nodeSelector
      value:
        kubernetes.io/hostname: codeai
    - op: replace
      path: /spec/template/spec/volumes
      value:
        - name: data-input
          persistentVolumeClaim:
            claimName: montage-ai-input-nfs
        - name: data-music
          persistentVolumeClaim:
            claimName: montage-ai-music-nfs
        - name: data-assets
          persistentVolumeClaim:
            claimName: montage-ai-assets-nfs
        - name: data-output
          persistentVolumeClaim:
            claimName: montage-ai-output-nfs
        - name: dev-dri
          hostPath:
            path: /dev/dri
            type: DirectoryOrCreate
  target:
    kind: Deployment
    name: montage-ai-web
