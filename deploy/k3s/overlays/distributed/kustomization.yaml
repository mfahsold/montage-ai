# Distributed Rendering Overlay
#
# Uses NFS storage for multi-node GPU access.
# Jobs can run on ANY GPU node (AMD, Jetson, or both).
#
# Usage:
#   kubectl apply -k deploy/k3s/overlays/distributed/

apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: montage-ai

# Use ghcr.io
images:
  - name: ghcr.io/mfahsold/montage-ai
    newTag: latest

resources:
  - ../../base
  - nfs-pvc.yaml

configMapGenerator:
  - name: montage-builder-patch
    files:
      - montage_builder.py

patches:
  # Use JSON 6902 patch to REPLACE volumes (not add)
  - target:
      kind: Job
      name: montage-ai-render
    patch: |-
      - op: replace
        path: /spec/template/spec/nodeSelector
        value: null
      - op: replace
        path: /spec/template/spec/affinity
        value:
          nodeAffinity:
            preferredDuringSchedulingIgnoredDuringExecution:
              - weight: 100
                preference:
                  matchExpressions:
                    - key: nvidia.com/gpu
                      operator: Exists
              - weight: 90
                preference:
                  matchExpressions:
                    - key: amd.com/gpu
                      operator: Exists
      - op: replace
        path: /spec/template/spec/volumes
        value:
          - name: input
            persistentVolumeClaim:
              claimName: montage-ai-input-nfs
          - name: music
            persistentVolumeClaim:
              claimName: montage-ai-music-nfs
          - name: assets
            persistentVolumeClaim:
              claimName: montage-ai-assets-nfs
          - name: output
            persistentVolumeClaim:
              claimName: montage-ai-output-nfs
          - name: cgpu-config
            emptyDir: {}
          - name: cgpu-secrets
            secret:
              secretName: cgpu-credentials
              optional: true
              items:
                - key: config.json
                  path: config.json
                - key: session.json
                  path: session.json
          - name: dev-dri
            hostPath:
              path: /dev/dri
              type: DirectoryOrCreate
          - name: code-patch
            configMap:
              name: montage-builder-patch
      - op: add
        path: /spec/template/spec/containers/0/volumeMounts/-
        value:
          name: code-patch
          mountPath: /app/src/montage_ai/core/montage_builder.py
          subPath: montage_builder.py
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: FFMPEG_HWACCEL
          value: "auto"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: USE_GPU
          value: "prefer"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: CGPU_ENABLED
          value: "true"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: CGPU_TIMEOUT
          value: "1800"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: QUALITY_PROFILE
          value: "master"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: CUT_STYLE
          value: "documentary"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: CREATIVE_PROMPT
          value: "Create a cinematic documentary trailer. Use slow pacing, dramatic music, and focus on visual storytelling. Color grade for a cinematic look."
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: OUTPUT_CODEC
          value: "libx265"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: OUTPUT_PIX_FMT
          value: "yuv420p10le"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: OUTPUT_PROFILE
          value: "main10"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: UPSCALE
          value: "true"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: STABILIZE
          value: "true"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: ENHANCE
          value: "true"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: COLORLEVELS
          value: "true"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: LUMA_NORMALIZE
          value: "true"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: CLEAN_AUDIO
          value: "true"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: EXPORT_WIDTH
          value: "3840"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: EXPORT_HEIGHT
          value: "2160"
