# Production overlay for montage-ai
# High-quality settings with full GPU support and maximum resources
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - ../../base

namespace: montage-ai

# Use registry from config.env (via deploy.sh substitution)
images:
  - name: 192.168.1.12:5000/montage-ai
    newTag: latest

# Production deployment configuration
patches:
  # High-quality production settings
  - patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: montage-ai-web
        namespace: montage-ai
      spec:
        template:
          spec:
            affinity:
              nodeAffinity:
                preferredDuringSchedulingIgnoredDuringExecution:
                  # Strongly prefer AMD GPU nodes
                  - weight: 100
                    preference:
                      matchExpressions:
                        - key: accelerator
                          operator: In
                          values: ["amd-gpu"]
                  # Fallback to high-perf compute
                  - weight: 50
                    preference:
                      matchExpressions:
                        - key: tier
                          operator: In
                          values: ["compute", "render"]
            containers:
              - name: montage-ai
                resources:
                  requests:
                    cpu: "8"
                    memory: "32Gi"
                  limits:
                    cpu: "16"
                    memory: "64Gi"
                env:
                  - name: FFMPEG_HWACCEL
                    value: "auto"
                  - name: FFMPEG_PRESET
                    value: "slow"
                  - name: UPSCALE
                    value: "true"
                  - name: ENHANCE
                    value: "true"

# Production config settings
configMapGenerator:
  - name: montage-ai-config
    behavior: merge
    literals:
      - CUT_STYLE=dynamic
      - STABILIZE=true
      - UPSCALE=true
      - ENHANCE=true
      - FFMPEG_PRESET=slow
      - VERBOSE=true
