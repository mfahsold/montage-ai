{% extends "base.html" %}
{% from "components/icon.html" import icon %}
{% import "components/macros.html" as m %}

{% block title %}Shorts Studio - Montage AI{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/icons.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/shorts.css') }}">
    <script src="https://unpkg.com/lucide@latest" defer></script>
{% endblock %}

{% block content %}
    <div class="mb-8">
        <h1 class="voxel-title glitch-text">SHORTS STUDIO</h1>
        <p class="text-muted">// Create 9:16 vertical shorts. AI crops, frames, & optimizes for mobile feeds.</p>
        <div class="cyber-progress mt-1"></div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <!-- LEFT: Phone Preview Frame (9:16) -->
        <div>
            <h3 class="text-primary text-sm mb-2">PHONE PREVIEW (9:16)</h3>
            <div class="phone-frame">
                <div class="phone-notch"></div>
                <div class="phone-screen">
                    <video id="previewVideo" style="display: none;"></video>
                    <div id="previewPlaceholder" style="width: 100%; height: 100%; background: #111; display: flex; align-items: center; justify-content: center; color: var(--muted);">
                        <span class="text-xs">No footage loaded</span>
                    </div>
                    <div class="safe-zone-overlay" id="safeZoneOverlay">
                        <div class="safe-zone-top"></div>
                        <div class="safe-zone-bottom"></div>
                    </div>
                </div>
            </div>
            
            <!-- Safe Zone Toggle -->
            <div class="mt-3">
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" id="toggleSafeZone" class="w-4 h-4">
                    <span class="text-xs text-muted">Show Safe Zones</span>
                </label>
            </div>

            <!-- Preview Controls -->
            <div class="mt-3 space-y-2">
                <button id="playBtn" class="voxel-btn voxel-btn-small w-full">▶ Play Preview</button>
                <button id="pauseBtn" class="voxel-btn voxel-btn-small w-full">⏸ Pause</button>
            </div>
        </div>

        <!-- MIDDLE: Clip Selection & Trimming -->
        <div>
            <h3 class="text-primary text-sm mb-2">SELECT CLIP</h3>
            
            <div id="clipList" class="space-y-2 mb-4 max-h-96 overflow-y-auto">
                <!-- Clips populated by JS -->
                <div class="text-xs text-muted p-2 border border-muted rounded">Loading clips...</div>
            </div>

            <!-- Trim Controls -->
            <div class="voxel-card">
                <h4 class="text-xs text-primary mb-2">TRIM SELECTED CLIP</h4>
                
                <div class="slider-container">
                    <div class="slider-labels">
                        <span class="text-xs text-muted">Start</span>
                        <span id="trimStartTime" class="text-xs text-primary font-mono">0:00</span>
                    </div>
                    <input type="range" id="trimStart" min="0" max="100" value="0" class="w-full">
                </div>

                <div class="slider-container mt-3">
                    <div class="slider-labels">
                        <span class="text-xs text-muted">End</span>
                        <span id="trimEndTime" class="text-xs text-primary font-mono">0:05</span>
                    </div>
                    <input type="range" id="trimEnd" min="0" max="100" value="100" class="w-full">
                </div>
            </div>
        </div>

        <!-- RIGHT: Rendering Options -->
        <div>
            <h3 class="text-primary text-sm mb-2">RENDER OPTIONS</h3>
            
            <div class="voxel-card">
                <!-- Reframe Strategy -->
                <div class="mb-4">
                    <label class="tech-label text-xs">REFRAME STRATEGY</label>
                    <select name="reframe_mode" id="reframeMode" class="voxel-input w-full text-xs">
                        <option value="face">Face-Locked (MediaPipe)</option>
                        <option value="center">Center Crop</option>
                        <option value="flow">Optical Flow</option>
                        <option value="manual">Manual Pan/Zoom</option>
                    </select>
                    <p class="text-xs text-muted mt-1">How to adapt 16:9 to 9:16.</p>
                </div>

                <!-- Captions -->
                <div class="mb-4">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" name="add_captions" id="addCaptions" class="w-4 h-4">
                        <span class="text-xs text-muted">Auto-Captions</span>
                    </label>
                    <p class="text-xs text-muted mt-1">Burn auto-transcribed captions into shorts.</p>
                </div>

                <!-- Aspect Ratio Overlay -->
                <div class="mb-4">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" name="show_guides" id="showGuides" class="w-4 h-4">
                        <span class="text-xs text-muted">Show Framing Guides</span>
                    </label>
                </div>

                <!-- Quality -->
                <div class="mb-4">
                    <label class="tech-label text-xs">QUALITY</label>
                    <select name="quality" id="quality" class="voxel-input w-full text-xs">
                        <option value="preview">Preview (480p)</option>
                        <option value="standard">Standard (1080p)</option>
                        <option value="high">High (1440p)</option>
                    </select>
                </div>

                <!-- Submit -->
                <button type="button" id="renderBtn" class="voxel-btn voxel-btn-primary w-full text-sm">
                    RENDER SHORT
                </button>
            </div>

            <!-- Progress Section -->
            <div id="progressSection" class="voxel-card mt-4 hidden">
                <div id="progressPhase" class="text-xs text-primary mb-1">Processing...</div>
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill" style="width: 0%;"></div>
                </div>
                <div id="progressPercent" class="text-xs text-muted text-center mt-1">0%</div>
            </div>

            <!-- Status Messages -->
            <div id="successMessage" class="voxel-card mt-4 hidden bg-success text-bg">
                <p class="text-xs">✅ Short rendered successfully!</p>
                <a href="/gallery" class="text-primary text-xs underline mt-2 block">View in Gallery →</a>
            </div>

            <div id="errorMessage" class="voxel-card mt-4 hidden bg-error text-bg">
                <p class="text-xs">⚠️ Rendering failed</p>
                <p id="errorText" class="text-xs text-muted mt-1"></p>
            </div>
        </div>
    </div>

    <!-- Engagement Metrics (After Render) -->
    <div id="engagementSection" class="hidden mt-8">
        <h3 class="text-primary mb-4">ENGAGEMENT FORECAST</h3>
        <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
            <div class="voxel-card text-center">
                <div class="engagement-grade text-3xl font-bold text-secondary mb-2" id="engagementGrade">-</div>
                <p class="text-xs text-muted">ENGAGEMENT SCORE</p>
            </div>
            <div class="voxel-card">
                <p class="text-xs text-primary mb-1">Hook Strength</p>
                <div class="progress-bar"><div id="hookScoreBar" class="progress-fill" style="width: 0%;"></div></div>
            </div>
            <div class="voxel-card">
                <p class="text-xs text-primary mb-1">Energy Level</p>
                <div class="progress-bar"><div id="energyScoreBar" class="progress-fill" style="width: 0%;"></div></div>
            </div>
            <div class="voxel-card">
                <p class="text-xs text-primary mb-1">Pacing</p>
                <div class="progress-bar"><div id="pacingScoreBar" class="progress-fill" style="width: 0%;"></div></div>
            </div>
            <div class="voxel-card">
                <p class="text-xs text-primary mb-1">Audio Mix</p>
                <div class="progress-bar"><div id="audioScoreBar" class="progress-fill" style="width: 0%;"></div></div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <script>
        // Shorts Studio JavaScript
        document.addEventListener('DOMContentLoaded', function() {
            const playBtn = document.getElementById('playBtn');
            const pauseBtn = document.getElementById('pauseBtn');
            const toggleSafeZone = document.getElementById('toggleSafeZone');
            const previewVideo = document.getElementById('previewVideo');
            const safeZoneOverlay = document.getElementById('safeZoneOverlay');
            const renderBtn = document.getElementById('renderBtn');
            const trimStart = document.getElementById('trimStart');
            const trimEnd = document.getElementById('trimEnd');
            const trimStartTime = document.getElementById('trimStartTime');
            const trimEndTime = document.getElementById('trimEndTime');

            // Play/Pause Controls
            playBtn?.addEventListener('click', () => previewVideo.play());
            pauseBtn?.addEventListener('click', () => previewVideo.pause());

            // Safe Zone Toggle
            toggleSafeZone?.addEventListener('change', (e) => {
                safeZoneOverlay.classList.toggle('visible', e.target.checked);
            });

            // Trim Slider Update
            const updateTrimTimes = () => {
                const duration = 5; // Example: 5 second default
                const startSec = Math.round((trimStart.value / 100) * duration);
                const endSec = Math.round((trimEnd.value / 100) * duration);
                trimStartTime.textContent = `0:${startSec.toString().padStart(2, '0')}`;
                trimEndTime.textContent = `0:${endSec.toString().padStart(2, '0')}`;
            };

            trimStart?.addEventListener('input', updateTrimTimes);
            trimEnd?.addEventListener('input', updateTrimTimes);

            // Render Button
            renderBtn?.addEventListener('click', async () => {
                const progressSection = document.getElementById('progressSection');
                const progressFill = document.getElementById('progressFill');
                const progressPercent = document.getElementById('progressPercent');
                
                progressSection.classList.remove('hidden');
                
                // Simulate progress
                for (let i = 0; i <= 100; i += 10) {
                    progressFill.style.width = i + '%';
                    progressPercent.textContent = i + '%';
                    await new Promise(r => setTimeout(r, 300));
                }

                document.getElementById('successMessage').classList.remove('hidden');
                document.getElementById('engagementSection').classList.remove('hidden');
            });

            // Load Clips (Mock)
            const clipList = document.getElementById('clipList');
            if (clipList) {
                clipList.innerHTML = `
                    <div class="clip-item voxel-card cursor-pointer active">
                        <p class="text-xs font-bold text-primary">Clip 1</p>
                        <p class="text-xs text-muted">0:00 - 0:15</p>
                    </div>
                    <div class="clip-item voxel-card cursor-pointer">
                        <p class="text-xs font-bold text-primary">Clip 2</p>
                        <p class="text-xs text-muted">0:15 - 0:30</p>
                    </div>
                `;
            }
        });
    </script>
{% endblock %}
